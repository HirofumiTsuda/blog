<!doctype html><html dir=ltr lang=en data-theme class="html theme--light"><head><title>Hirofumi Tsuda
|
Snowflake Architectures: Database Storage</title><meta charset=utf-8><meta name=generator content="Hugo 0.119.0"><meta name=viewport content="width=device-width,initial-scale=1,viewport-fit=cover"><meta name=author content="Hirofumi Tsuda"><meta name=description content="A warehouse of my thoughts, ideas and studies"><link rel=stylesheet href=/blog/scss/main.min.1147aa5bacb4bce677a0e264073829caedb82fd18ea07a5f1d80521f539d1c45.css integrity="sha256-EUeqW6y0vOZ3oOJkBzgpyu24L9GOoHpfHYBSH1OdHEU=" crossorigin=anonymous type=text/css><link rel=stylesheet href=/blog/css/markupHighlight.min.73ccfdf28df555e11009c13c20ced067af3cb021504cba43644c705930428b00.css integrity="sha256-c8z98o31VeEQCcE8IM7QZ688sCFQTLpDZExwWTBCiwA=" crossorigin=anonymous type=text/css><link rel=stylesheet href=/blog/fontawesome/css/fontawesome.min.7d272de35b410fb165377550cdf9c4d3a80fbbcc961e111914e4d5c0eaf5729f.css integrity="sha256-fSct41tBD7FlN3VQzfnE06gPu8yWHhEZFOTVwOr1cp8=" crossorigin=anonymous type=text/css><link rel=stylesheet href=/blog/fontawesome/css/solid.min.55d8333481b07a08e07cf6f37319753a2b47e99f4c395394c5747b48b495aa9b.css integrity="sha256-VdgzNIGwegjgfPbzcxl1OitH6Z9MOVOUxXR7SLSVqps=" crossorigin=anonymous type=text/css><link rel=stylesheet href=/blog/fontawesome/css/regular.min.a7448d02590b43449364b6b5922ed9af5410abb4de4238412a830316dedb850b.css integrity="sha256-p0SNAlkLQ0STZLa1ki7Zr1QQq7TeQjhBKoMDFt7bhQs=" crossorigin=anonymous type=text/css><link rel=stylesheet href=/blog/fontawesome/css/brands.min.9ed75a5d670c953fe4df935937674b4646f92674367e9e66eb995bb04e821647.css integrity="sha256-ntdaXWcMlT/k35NZN2dLRkb5JnQ2fp5m65lbsE6CFkc=" crossorigin=anonymous type=text/css><link rel="shortcut icon" href=/blog/favicon.ico type=image/x-icon><link rel=apple-touch-icon sizes=180x180 href=/blog/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/blog/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/blog/favicon-16x16.png><link rel=canonical href=http://HirofumiTsuda.github.io/blog/posts/snowflake3/><script type=text/javascript src=/blog/js/anatole-header.min.f9132794301a01ff16550ed66763482bd848f62243d278f5e550229a158bfd32.js integrity="sha256-+RMnlDAaAf8WVQ7WZ2NIK9hI9iJD0nj15VAimhWL/TI=" crossorigin=anonymous></script>
<script type=text/javascript src=/blog/js/anatole-theme-switcher.min.d6d329d93844b162e8bed1e915619625ca91687952177552b9b3e211014a2957.js integrity="sha256-1tMp2ThEsWLovtHpFWGWJcqRaHlSF3VSubPiEQFKKVc=" crossorigin=anonymous></script><meta name=twitter:card content="summary"><meta name=twitter:title content="Snowflake Architectures: Database Storage"><meta name=twitter:description content><meta property="og:title" content="Snowflake Architectures: Database Storage"><meta property="og:description" content><meta property="og:type" content="article"><meta property="og:url" content="http://HirofumiTsuda.github.io/blog/posts/snowflake3/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-01-06T16:10:30+09:00"><meta property="article:modified_time" content="2024-01-06T16:10:30+09:00"><meta property="og:site_name" content="Coffee, Codes, Mathematics and Heavy Metal"><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","articleSection":"posts","name":"Snowflake Architectures: Database Storage","headline":"Snowflake Architectures: Database Storage","alternativeHeadline":"","description":"
      
        


      


    ","inLanguage":"en-us","isFamilyFriendly":"true","mainEntityOfPage":{"@type":"WebPage","@id":"http:\/\/HirofumiTsuda.github.io\/blog\/posts\/snowflake3\/"},"author":{"@type":"Person","name":"Hirofumi Tsuda"},"creator":{"@type":"Person","name":"Hirofumi Tsuda"},"accountablePerson":{"@type":"Person","name":"Hirofumi Tsuda"},"copyrightHolder":{"@type":"Person","name":"Hirofumi Tsuda"},"copyrightYear":"2024","dateCreated":"2024-01-06T16:10:30.00Z","datePublished":"2024-01-06T16:10:30.00Z","dateModified":"2024-01-06T16:10:30.00Z","publisher":{"@type":"Organization","name":"Hirofumi Tsuda","url":"http://HirofumiTsuda.github.io/blog/","logo":{"@type":"ImageObject","url":"http:\/\/HirofumiTsuda.github.io\/blog\/favicon-32x32.png","width":"32","height":"32"}},"image":[],"url":"http:\/\/HirofumiTsuda.github.io\/blog\/posts\/snowflake3\/","wordCount":"648","genre":["tech"],"keywords":["snowflake","architectures"]}</script></head><body class=body><div class=wrapper><aside class=wrapper__sidebar><div class="sidebar
animated fadeInDown"><div class=sidebar__content><div class=sidebar__introduction><img class=sidebar__introduction-profileimage src=/blog/assets/images/profile/profile.jpeg alt="profile picture"><div class=sidebar__introduction-title><a href=/blog>Coffee, Codes, Mathematics and Heavy Metal</a></div><div class=sidebar__introduction-description><p>A warehouse of my thoughts, ideas and studies</p></div></div><ul class=sidebar__list><li class=sidebar__list-item><a href=https://www.linkedin.com/in/hirofumitsuda23/ target=_blank rel="noopener me" aria-label title><i class="fab fa-linkedin fa-2x" aria-hidden=true></i></a></li></ul></div><footer class="footer footer__sidebar"><ul class=footer__list><li class=footer__item>&copy;
Hirofumi Tsuda
2024</li></ul></footer><script type=text/javascript src=/blog/js/medium-zoom.min.1248fa75275e5ef0cbef27e8c1e27dc507c445ae3a2c7d2ed0be0809555dac64.js integrity="sha256-Ekj6dSdeXvDL7yfoweJ9xQfERa46LH0u0L4ICVVdrGQ=" crossorigin=anonymous></script></div></aside><main class=wrapper__main><header class=header><div class="animated fadeInDown"><a role=button class=navbar-burger data-target=navMenu aria-label=menu aria-expanded=false><span aria-hidden=true class=navbar-burger__line></span>
<span aria-hidden=true class=navbar-burger__line></span>
<span aria-hidden=true class=navbar-burger__line></span></a><nav class=nav><ul class=nav__list id=navMenu><li class=nav__list-item><a href=/blog/ title>Home</a></li><li class=nav__list-item><a href=/blog/posts/ title>All Posts</a></li><li class=nav__list-item><a href=/blog/categories/ title>Categories</a></li><li class=nav__list-item><a href=/blog/tags/ title>Tags</a></li></ul><ul class="nav__list nav__list--end"><li class=nav__list-item><div class=themeswitch><a title="Switch Theme"><i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></li></ul></nav></div></header><div class="post
animated fadeInDown"><div class=post__content><h1>Snowflake Architectures: Database Storage</h1><h2 id=introduction>Introduction</h2><p>I have shown two architectures: <a href=http://HirofumiTsuda.github.io/blog/posts/snowflake1/>Cloud Service</a> and <a href=http://HirofumiTsuda.github.io/blog/posts/snowflake2/>Query Processing</a>. The last remaining architecture is <code>Database Storage</code>.</p><p>This <code>Database Storage</code> contains data of tables. Note that their metadata are put on <code>Cloud Service</code> architecture. In the storage, all the data are managed in units called <code>Micro Partition</code>.</p><h2 id=micro-partition>Micro Partition</h2><p>Once data is loaded into a table, that data is separated into <code>Micro Partitions</code>. <a href=https://docs.snowflake.com/ja/user-guide/tables-clustering-micropartitions>An official document</a> shows its behavior.</p><p><img src=tables-clustered1.png alt=snowflake_micro_partition></p><p>As seen in the figure, data in a table consists of four parts. This process is automatically done inside Snowflake. The noticeable points are:</p><ul><li>Data is separated in a straightforward way: following the original order of rows.</li><li>Each micro-partition has its own metadata.</li><li>Micro-partition is immutable: once it is created, it is never changed.</li></ul><p>The first one is that rows are NOT sorted to be separated into micro-partitions. As the figure shows, the micro-partition 1 has the first six rows. the micro-partition 2 has elements with the row-number being between 7 and 12.</p><p>The second one is that metadata are managed in units of micro-partitions. For example, on the micro-partition 1 (see the figure), the type column has the range from 2 to 4. Therefore in its metadata, the minimum and maximum values are set 2 and 4, respectively. This metadata is used for pruning. Let us think of the following query.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>SELECT</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>*</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>FROM</span> <span style=color:#66d9ef>table</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>WHERE</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>type</span> <span style=color:#f92672>&gt;=</span> <span style=color:#ae81ff>5</span>
</span></span></code></pre></div><p>As the where clause defines, only elements with type being larger than 4 are required, that is, no elements in the micro-partition 1 are needed. Then using the metadata, the micro-partition 1 is not loaded.</p><p>The last one is that micro-partitions are never changed. Even if a table is updated, then new micro-partitions are created (not replaced!). Therefore, snowflake does not provide dirty read because data is not changed in a sense of micro-partitions.</p><p>As explained in the last, micro-partitions are not changed. Once a micro-partition is not referred, then it is dropped. That system is shown in the next section.</p><h2 id=time-travel--fail-safe>Time Travel / Fail Safe</h2><p>The two functions shown in the section&rsquo;s title are used to recover contents in a table. Although those two seem to be the same, their functions are completely different.</p><p>The <a href=https://docs.snowflake.com/ja/user-guide/data-time-travel>following figure</a> shows abstracts of those two (only <code>time travel</code> is marked though).</p><p><img src=cdp-lifecycle-tt.png alt=timetravel_failsafe></p><p>Time-travel offers us to recover a table as it used to be. You can revert changes like <code>UPDATE</code>, <code>DROP</code> and so on. The duration of its availability can be set as you want. The maximum date is 90 days if you use <code>Snowflake Enterprise Edition</code>. This operation can be executed by yourself.</p><p>After the term for the time-travel finishes, you cannot access to the previous data. But if you want to take data back to the previous, you can use <code>failsafe</code> function. Note that the operation is NOT done by yourself. All the operations are done by <code>Snowflake</code>.</p><p>From the above discussions, you may think of setting parameters involving available term as large as possible (e.g. setting the time-travel term 90 days). But then, it means micro-partitions lying on data stay 90 days after the table is dropped. Then additional costs incurred for data staying for 90 days have to be considered. From the view of costs, it is necessary to set those parameters.</p><h2 id=conclusion>Conclusion</h2><p>Although data-storage is not a part of a warehouse, it is highly involved with costs and performance (using pruning!). Especially, if data is large, you may have to think of how data is sorted (how micro-partitions are created). For example, if data has a timestamp showing update-time and the column is often used for pruning in a <code>where</code> clause, it would be efficient to order the data by the timestamp. That is because sorting data in such a way leads to generate micro-partitions without any overlap in the timestamp. Then, once the timestamp is designated in the <code>where</code> clause, only relevant micro-partitions are loaded.</p></div><div class=post__footer><span><a class=category href=/blog/categories/tech/>tech</a></span>
<span><a class=tag href=/blog/tags/snowflake/>snowflake</a><a class=tag href=/blog/tags/architectures/>architectures</a></span></div></div></main></div><footer class="footer footer__base"><ul class=footer__list><li class=footer__item>&copy;
Hirofumi Tsuda
2024</li></ul></footer><script type=text/javascript src=/blog/js/medium-zoom.min.1248fa75275e5ef0cbef27e8c1e27dc507c445ae3a2c7d2ed0be0809555dac64.js integrity="sha256-Ekj6dSdeXvDL7yfoweJ9xQfERa46LH0u0L4ICVVdrGQ=" crossorigin=anonymous></script></body></html>